# Beykusay Agent (beykus-y/agent.git)

## Описание

**Beykusay Agent** - это интеллектуальный Telegram-бот, разработанный на Python с использованием библиотеки `aiogram` (v3). Бот интегрирован с моделями искусственного интеллекта Google Gemini (Pro и Lite версии), что позволяет ему обрабатывать сообщения пользователей, вести диалог, выполнять различные задачи с помощью инструментов (Function Calling) и запоминать информацию.

Бот способен работать как в личных, так и в групповых чатах, применяя разные стратегии обработки в зависимости от контекста.

## Ключевые Возможности

*   **Интеграция с Google Gemini:** Использует мощные модели Gemini (Pro и Lite) для понимания и генерации ответов.
*   **Двухмодельная стратегия:**
    *   **Lite модель:** Используется в группах для быстрого анализа сообщений и определения необходимости реакции или запоминания информации.
    *   **Pro модель:** Используется для сложных задач, обработки сообщений в личных чатах и при явном вызове из групповых чатов.
*   **Function Calling:** Бот может использовать внешние инструменты и функции, такие как:
    *   Получение погоды (`get_current_weather`)
    *   Получение цен на акции (`get_stock_price`)
    *   Отправка сообщений в Telegram (`send_telegram_message`)
    *   Чтение/Запись/Создание файлов (`read_file_from_env`, `write_file_to_env`, `create_file_in_env`)
    *   Редактирование файлов (простой текст, Python AST, JSON) (`edit_file_content`, `replace_code_block_ast`, `edit_json_file`)
    *   Выполнение Python скриптов (`execute_python_script_in_env`)
    *   Выполнение команд терминала (`execute_terminal_command_in_env`)
    *   Запоминание информации о пользователе (`remember_user_info`)
*   **Персистентность данных:**
    *   Сохранение истории чатов в базе данных SQLite.
    *   Сохранение профилей пользователей и заметок о них.
*   **Изолированное окружение:** Операции с файлами и выполнение команд происходят в изолированных директориях для каждого чата (`env/{chat_id}`).
*   **Обработка Markdown:** Бот использует MarkdownV2 для форматирования сообщений и включает утилиту для экранирования.
*   **Асинхронность:** Построен на `asyncio` и `aiogram` для эффективной обработки множества запросов.

## Технологический стек

*   **Python:** 3.10+ (рекомендуется)
*   **aiogram:** 3.x (для взаимодействия с Telegram API)
*   **google-generativeai:** Библиотека для работы с Google Gemini API
*   **python-dotenv:** Для управления переменными окружения
*   **aiosqlite:** Асинхронная работа с SQLite
*   **aiofiles:** Асинхронная работа с файлами

## Установка и запуск

1.  **Клонировать репозиторий:**
    ```bash
    git clone https://github.com/beykus-y/agent.git
    cd agent
    ```

2.  **Создать и активировать виртуальное окружение:**
    ```bash
    python3 -m venv venv
    source venv/bin/activate  # Linux/macOS
    # venv\Scripts\activate  # Windows (cmd)
    # venv\Scripts\Activate.ps1 # Windows (PowerShell)
    ```

3.  **Установить зависимости:**
    ```bash
    pip install -r requirements.txt
    ```

4.  **Настроить переменные окружения:**
    Создайте файл `.env` в корневой директории проекта и добавьте в него необходимые переменные (см. секцию "Конфигурация").

5.  **Запустить бота:**
    ```bash
    python bot_main.py
    ```

## Конфигурация (`.env`)

Создайте файл `.env` в корне проекта со следующим содержимым:

```dotenv
# Обязательные переменные
TELEGRAM_BOT_TOKEN=ВАШ_ТЕЛЕГРАМ_БОТ_ТОКЕН
GOOGLE_API_KEY=ВАШ_GOOGLE_API_КЛЮЧ_ДЛЯ_GEMINI

# Необязательные переменные (имеют значения по умолчанию)
# LITE_GEMINI_MODEL=gemini-1.5-flash-latest
# PRO_GEMINI_MODEL=gemini-1.5-pro-latest
# DATABASE_FILE_PATH=db/bot_db.sqlite
```

*   `TELEGRAM_BOT_TOKEN`: Токен вашего Telegram бота, полученный от @BotFather.
*   `GOOGLE_API_KEY`: API ключ для доступа к Google Gemini API.
*   `LITE_GEMINI_MODEL`, `PRO_GEMINI_MODEL`: Имена моделей Gemini (можно изменить при необходимости).
*   `DATABASE_FILE_PATH`: Путь к файлу базы данных SQLite. По умолчанию используется `db/bot_db.sqlite`. Директория `db/` будет создана автоматически.

**Важно:** Не добавляйте файл `.env` в систему контроля версий (Git). Добавьте его в `.gitignore`.

## Структура Проекта

```
agent/
├── .env             # (Нужно создать) Переменные окружения
├── requirements.txt # Зависимости Python
├── bot_config.py    # Загрузка конфигурации, настройка логгера
├── bot_loader.py    # Инициализация Aiogram Bot и Dispatcher
├── bot_lifecycle.py # Логика запуска и остановки бота
├── bot_main.py      # Главная точка входа для запуска бота
├── bot_processing.py # Логика обработки цикла Function Calling
├── bot_utils.py     # Вспомогательные утилиты (Markdown, конвертация истории)
├── database.py      # Взаимодействие с базой данных (SQLite)
├── tool_handlers.py # Реализация функций-инструментов для Gemini
├── gemini_api.py    # Взаимодействие с Google Gemini API
├── handlers/        # Обработчики сообщений
│   ├── __init__.py
│   ├── common.py    # Общая логика для обработчиков
│   ├── private.py   # Обработчик личных сообщений
│   └── group.py     # Обработчик групповых сообщений
├── prompt/          # Файлы с промптами для моделей Gemini
│   ├── lite_model_group_analyzer.txt # Промпт Lite-модели для групп
│   ├── pro_model_assistant.txt     # Промпт Pro-модели
│   └── ... (другие файлы промптов, декларации функций .json)
├── db/              # Директория по умолчанию для БД
│   └── bot_db.sqlite # Файл БД (создается при первом запуске)
└── env/             # Директория для изолированных окружений чатов
    └── {chat_id}/   # Поддиректория для файлов конкретного чата
```

## Ключевые Концепции Логики

*   **Стратегия Lite/Pro в Группах:** Сообщения в группах сначала анализируются быстрой Lite-моделью (`lite_model_group_analyzer.txt`). Если требуется сложное действие, вызывается Pro-модель. Если информации достаточно для запоминания (`remember_user_info`) или действие не требуется (`NO_ACTION_NEEDED`), Pro-модель не задействуется.
*   **Цикл Function Calling:** `bot_processing.py` реализует основной цикл: модель возвращает запрос на вызов функции -> `execute_function_call` выполняет соответствующий хендлер из `tool_handlers.py` -> результат (`FunctionResponse`) отправляется обратно модели -> модель генерирует следующий шаг или финальный ответ.
*   **Промпты:** Поведение моделей (особенно Pro) сильно зависит от инструкций в файлах `prompt/pro_model_assistant.txt` и `prompt/lite_model_group_analyzer.txt`. Pro-модель инструктирована действовать как "Исполнитель Задач", используя `send_telegram_message` для любого текстового вывода.
*   **База Данных:** Используется SQLite для хранения истории сообщений (с фильтрацией при сохранении), профилей и заметок пользователей (`user_notes`).
*   **Изоляция Окружения:** Функции, работающие с файлами или командами, ограничены директорией `env/{chat_id}`, чтобы предотвратить доступ к остальной системе.

## Известные Проблемы и TODO

*   **~~Критическая Ошибка API Gemini~~ (Исправлено?):** Ранее наблюдалась ошибка `MALFORMED_FUNCTION_CALL` при отправке `FunctionResponse` (особенно с кодом или специфичными строками) обратно в API. *Вероятно, исправлено добавлением экранирования `\n` в `bot_processing.py`, но требует дополнительного наблюдения.*
*   **Неполное Сохранение Истории FC:** При многошаговых операциях Function Calling в БД сохраняется не вся история цикла (часто только 1 запись из N). Логику `save_new_history_entries` нужно пересмотреть для более полного сохранения контекста.
*   **Поведение Lite Модели:** Иногда Lite модель в группах генерирует текст вместо маркера `NO_ACTION_NEEDED` или вызова функции, что приводит к неявному запуску Pro модели. Требуется доработка промпта или логики обработки ее ответа.
*   **Обработка Ошибок API:** Недостаточно надежная обработка сетевых ошибок, тайм-аутов или неожиданных ответов от API Gemini и Telegram.
*   **Безопасность Команд:** Фильтрация команд в `execute_terminal_command_in_env` базовая. Требуется более надежный подход (белый список, анализ команд, улучшенная изоляция).
*   **Отсутствие Тестов:** Нет автоматизированных тестов (юнит-тесты, интеграционные).
*   **Документация Кода:** Недостаточно комментариев и docstrings внутри кода.
*   **Консолидация Конфигурации:** Параметры генерации Gemini (`temperature` и т.д.) используются из заглушки в `gemini_api.py`, а не из `bot_config.py`.
*   **Пустые Файлы Промптов:** Некоторые файлы `.txt` в `prompt/` пусты.

## Вклад

Предложения по улучшению, исправления багов и новые функции приветствуются. Пожалуйста, создавайте Issue для обсуждения или Pull Request с вашими изменениями.

## Лицензия

[MIT License]
